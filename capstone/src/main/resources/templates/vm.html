<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>VM Details - Debug Mode</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/vm.css}">
</head>
<body>
<div class="container">
    <div class="header">
        <h1 th:text="'VM: ' + ${vmName}">VM Details</h1>
        <a href="/" class="back-link">&larr; Back to VM List</a>
    </div>

    <div>
        <h2>VNC Console</h2>
        <div class="status-indicator">
            <div class="status-dot disconnected" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
        
        <button class="btn-primary" onclick="connectVNC()">Connect to VNC</button>
        <button class="btn-secondary" onclick="disconnectVNC()">Disconnect</button>
        <button class="btn-secondary" onclick="clearDebug()">Clear Debug</button>
        
        <h3>Debug Output:</h3>
        <div class="debug-output" id="debugOutput">Waiting for connection...</div>
        
        <h3>VNC Display:</h3>
        <div id="noVNC_screen"></div>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 4px;">
        <h3>Debug Information:</h3>
        <p><strong>VM Name:</strong> <span th:text="${vmName}">-</span></p>
        <p><strong>VNC Info:</strong> <span th:text="${vncInfo}">-</span></p>
        <p><strong>VNC Port:</strong> <span th:text="${vncPort}">-</span></p>
    </div>
</div>

<!-- noVNC Library -->
<script type="module">
    import RFB from 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js';
    window.RFB = RFB;
    console.log('noVNC RFB loaded:', typeof RFB);
</script>

<script th:inline="javascript">
    var vmName = /*[[${vmName}]]*/ 'default';
    var cleanVmName = vmName.replace(' (stopped)', '').trim();
    var rfb = null;
    var debugLines = [];

    function addDebug(message) {
        var timestamp = new Date().toLocaleTimeString();
        debugLines.push('[' + timestamp + '] ' + message);
        if (debugLines.length > 100) debugLines.shift();
        document.getElementById('debugOutput').innerHTML = debugLines.join('<br>');
        document.getElementById('debugOutput').scrollTop = document.getElementById('debugOutput').scrollHeight;
    }

    function clearDebug() {
        debugLines = [];
        document.getElementById('debugOutput').innerHTML = 'Debug cleared...';
    }

    function updateStatus(connected) {
        var dot = document.getElementById('statusDot');
        var text = document.getElementById('statusText');
        
        if (connected) {
            dot.className = 'status-dot connected';
            text.textContent = 'Connected';
        } else {
            dot.className = 'status-dot disconnected';
            text.textContent = 'Disconnected';
        }
    }

    function connectVNC() {
        addDebug('Starting connection process...');
        addDebug('VM Name: ' + cleanVmName);
        
        // Wait for RFB to load
        if (typeof window.RFB === 'undefined') {
            addDebug('Waiting for noVNC library to load...');
            setTimeout(connectVNC, 500);
            return;
        }
        
        addDebug('noVNC library loaded successfully');
        
        try {
            var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            var wsUrl = protocol + '//' + window.location.host + '/ws/vnc/' + encodeURIComponent(cleanVmName);
            
            addDebug('WebSocket URL: ' + wsUrl);
            addDebug('Creating RFB connection...');
            
            // Clear previous display
            document.getElementById('noVNC_screen').innerHTML = '';
            
            // Create noVNC RFB object
            rfb = new window.RFB(document.getElementById('noVNC_screen'), wsUrl, {
                shared: true,
                credentials: {}
            });
            
            addDebug('RFB object created');
            
            // Event handlers
            rfb.addEventListener("connect", function(e) {
                addDebug('✓ RFB CONNECT event fired');
                addDebug('Connection details: ' + JSON.stringify(e.detail || {}));
                updateStatus(true);
            });
            
            rfb.addEventListener("disconnect", function(e) {
                addDebug('✗ RFB DISCONNECT event fired');
                addDebug('Clean disconnect: ' + e.detail.clean);
                addDebug('Reason: ' + (e.detail.reason || 'Unknown'));
                updateStatus(false);
            });
            
            rfb.addEventListener("credentialsrequired", function() {
                addDebug('⚠ Credentials required (VM may have VNC password)');
            });
            
            rfb.addEventListener("securityfailure", function(e) {
                addDebug('✗ Security failure: ' + e.detail.reason);
                addDebug('Status: ' + e.detail.status);
                updateStatus(false);
            });
            
            rfb.addEventListener("clipboard", function(e) {
                addDebug('Clipboard event: ' + e.detail.text.substring(0, 50));
            });
            
            rfb.addEventListener("bell", function() {
                addDebug('Bell event received');
            });
            
            rfb.addEventListener("desktopname", function(e) {
                addDebug('Desktop name: ' + e.detail.name);
            });
            
            rfb.addEventListener("capabilities", function(e) {
                addDebug('Capabilities: ' + JSON.stringify(e.detail));
            });
            
            // Set scaling mode
            rfb.scaleViewport = true;
            rfb.resizeSession = false;
            
            addDebug('Waiting for VNC server response...');
            
        } catch (error) {
            addDebug('✗ ERROR: ' + error.message);
            addDebug('Stack: ' + error.stack);
            updateStatus(false);
        }
    }

    function disconnectVNC() {
        addDebug('Disconnecting...');
        if (rfb) {
            rfb.disconnect();
            rfb = null;
        }
        document.getElementById('noVNC_screen').innerHTML = '';
        updateStatus(false);
        addDebug('Disconnected');
    }

    window.connectVNC = connectVNC;
    window.disconnectVNC = disconnectVNC;
    window.clearDebug = clearDebug;
    
    addDebug('Page loaded. Ready to connect.');
    addDebug('Clean VM name: ' + cleanVmName);
</script>
</body>
</html>
